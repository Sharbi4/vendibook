// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          UserRole  @default(USER)
  
  // Profile
  phoneNumber   String?
  avatarUrl     String?
  bio           String?
  
  // Address masking for hosts
  displayCity   String?
  displayState  String?
  displayLocation String?
  preciseAddress String?  // Exact address - protected
  coordinates   Json?     // { lat, lng } - protected
  
  // Professional info (for hosts/event pros)
  businessName  String?
  businessLicense String?
  insuranceStatus String?  // VERIFIED, PENDING, EXPIRED
  serviceAreas  String[]   // Service radius cities
  
  // Event Pro specialization
  eventProCategories String[]  // CHEF, BARTENDER, DJ, CATERER, etc
  eventProRating Float @default(0)
  eventProReviews Int @default(0)
  
  // Seller specific
  sellerVerified Boolean @default(false)
  titleVerified  Boolean @default(false)
  remoteNotaryUsed Boolean @default(false)
  
  // Relationships
  hostListings  HostListing[]
  bookings      Booking[]
  inquiries     Inquiry[]
  events        EventRequest[]
  reviews       Review[]
  auditLogs     AuditLog[]
  sentMessages  Message[] @relation("sender")
  receivedMessages Message[] @relation("recipient")
  messageThreads MessageThread[]
  wishlist      Wishlist[]
  recentlyViewed RecentlyViewed[]
  documents     Document[]
  subscriptions Subscription[]
  transactions  Transaction[]
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@index([email])
  @@index([createdAt])
}

enum UserRole {
  USER
  HOST
  ADMIN
}

// ============================================================================
// PUBLIC LISTINGS (Marketplace)
// ============================================================================

model Listing {
  id              String    @id @default(cuid())
  title           String
  description     String    @db.Text
  listingType     ListingType
  category        String
  
  // Location
  city            String
  state           String
  location        String
  
  // Pricing
  price           Float
  priceUnit       String    // "per day", "per hour", "one-time"
  
  // Details
  imageUrl        String?
  tags            String[]  // Array of amenities/features
  highlights      String[]  // Array of highlights
  
  // Verification & Status
  isVerified      Boolean   @default(false)
  deliveryAvailable Boolean @default(false)
  
  // Host info (denormalized for search)
  hostName        String
  
  // Ratings
  rating          Float     @default(0)
  reviewCount     Int       @default(0)
  
  // Metadata
  views           Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relationships (for search)
  reviews         Review[]
  
  @@index([listingType])
  @@index([category])
  @@index([city])
  @@index([isVerified])
  @@fulltext([title, description])
}

enum ListingType {
  RENT
  SALE
  EVENT_PRO
}

// ============================================================================
// HOST LISTINGS (User-created listings)
// ============================================================================

model HostListing {
  id              String    @id @default(cuid())
  ownerId         String
  owner           User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  title           String
  description     String    @db.Text
  listingType     ListingType
  category        String
  
  // Location - with masking support
  city            String
  state           String
  location        String
  
  // Address masking fields
  displayLocation String?   // What renters see (e.g., "Downtown Miami area")
  preciseAddress  String?   // Exact address - only shown to approved bookers
  coordinates     Json?     // { lat, lng } - only shown to approved bookers
  
  // Pricing
  price           Float
  priceUnit       String    // "per day", "per hour", "one-time"
  
  // Details
  imageUrl        String?
  imageUrls       String[]  // Array of image URLs
  tags            String[]  // Array of amenities/features
  highlights      String[]  // Array of highlights
  
  // Availability
  status          ListingStatus @default(DRAFT)
  
  // Verification
  isVerified      Boolean   @default(false)
  deliveryAvailable Boolean @default(false)
  maxRentalDuration Int?    // Days
  minRentalDuration Int?    // Days
  
  // Metadata
  views           Int       @default(0)
  inquiries       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?
  deletedAt       DateTime?  // Soft delete support
  
  // Relationships
  bookings        Booking[]
  inquiries       Inquiry[]
  events          EventRequest[]
  reviews         Review[]
  auditLogs       AuditLog[]
  statusLogs      StatusLog[]
  wishlistItems   Wishlist[]
  recentViews     RecentlyViewed[]
  documents       Document[]
  transactions    Transaction[]
  
  @@index([ownerId])
  @@index([listingType])
  @@index([category])
  @@index([city])
  @@index([status])
  @@index([createdAt])
  @@fulltext([title, description])
}

enum ListingStatus {
  DRAFT
  LIVE
  PAUSED
  SOLD
  ARCHIVED
}

// ============================================================================
// BOOKINGS (Rental requests)
// ============================================================================

model Booking {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  bookingType     BookingType
  status          BookingStatus @default(PENDING)
  
  // For RENT bookings
  startDate       DateTime?
  endDate         DateTime?
  
  // For EVENT_PRO bookings
  eventDate       DateTime?
  eventTime       DateTime?  // Specific time window
  eventLocation   String?
  eventDescription String?
  guestCount      Int?
  
  // Details
  message         String?   @db.Text
  price           Float?
  priceUnit       String?
  
  // Pricing breakdown
  subtotal        Float?
  platformFee     Float?
  discount        Float?
  totalPrice      Float?
  
  // Delivery & Pickup
  deliveryAddress String?
  deliveryDate    DateTime?
  pickupAddress   String?
  
  // Confirmation tracking
  hostConfirmedAt DateTime?
  renterConfirmedAt DateTime?
  
  // Return & Condition
  returnCondition String?  // PRISTINE, GOOD, FAIR, POOR
  returnPhotos    String[]
  returnNotes     String?  @db.Text
  
  // Multi-listing support
  bundleId        String?  // Group related bookings
  parentBookingId String?  // For linked bookings
  linkedBookings  String[]
  
  // Relationships
  documents       Document[]
  transactions    Transaction[]
  threadId        String?
  thread          MessageThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  respondedAt     DateTime?
  completedAt     DateTime?
  
  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([bundleId])
  @@index([createdAt])
}

enum BookingType {
  RENTAL_REQUEST
  EVENT_REQUEST
  PURCHASE_INQUIRY
}

enum BookingStatus {
  PENDING
  APPROVED
  DECLINED
  COMPLETED
  CANCELLED
}

// ============================================================================
// INQUIRIES (General messages for SALE listings)
// ============================================================================

model Inquiry {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  inquiryType     InquiryType
  status          InquiryStatus @default(OPEN)
  
  message         String    @db.Text
  price           Float?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  respondedAt     DateTime?
  
  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([createdAt])
}

enum InquiryType {
  PRICE_INQUIRY
  CONDITION_INQUIRY
  AVAILABILITY_INQUIRY
  GENERAL_INQUIRY
}

enum InquiryStatus {
  OPEN
  RESPONDED
  CLOSED
}

// ============================================================================
// EVENT REQUESTS (Specific to EVENT_PRO listings)
// ============================================================================

model EventRequest {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  eventDate       DateTime
  eventType       String    // e.g., "wedding", "corporate", "birthday"
  guestCount      Int
  budget          Float?
  message         String?   @db.Text
  
  status          EventRequestStatus @default(PENDING)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  approvedAt      DateTime?
  
  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([eventDate])
}

enum EventRequestStatus {
  PENDING
  APPROVED
  DECLINED
  COMPLETED
  CANCELLED
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  hostListingId   String?
  hostListing     HostListing? @relation(fields: [hostListingId], references: [id], onDelete: Cascade)
  
  rating          Int       // 1-5
  comment         String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([listingId])
  @@index([rating])
}

// ============================================================================
// IMAGE ASSETS
// ============================================================================

model ImageAsset {
  id              String    @id @default(cuid())
  url             String
  key             String    @unique  // S3 key
  size            Int       // Bytes
  mimeType        String
  width           Int?
  height          Int?
  
  createdAt       DateTime  @default(now())
  
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOGS
// ============================================================================

model AuditLog {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action          AuditAction
  resource        String    // e.g., "listing", "booking"
  resourceId      String
  
  listingId       String?
  listing         HostListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  changes         Json?     // Store what changed
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime  @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([resourceId])
  @@index([createdAt])
}

enum AuditAction {
  CREATE_LISTING
  UPDATE_LISTING
  DELETE_LISTING
  PUBLISH_LISTING
  PAUSE_LISTING
  CREATE_BOOKING
  UPDATE_BOOKING
  CANCEL_BOOKING
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id              String    @id @default(cuid())
  userId          String
  type            NotificationType
  title           String
  message         String    @db.Text
  relatedId       String?   // ID of related resource (booking, listing, etc)
  read            Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  readAt          DateTime?
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_APPROVED
  BOOKING_DECLINED
  INQUIRY_RECEIVED
  EVENT_REQUEST
  REVIEW_RECEIVED
  LISTING_PUBLISHED
  LISTING_FLAGGED
  MESSAGE_RECEIVED
}

// ============================================================================
// STATUS LOG (For tracking listing/booking state changes)
// ============================================================================

model StatusLog {
  id              String    @id @default(cuid())
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  fromStatus      String
  toStatus        String
  reason          String?   @db.Text
  
  createdAt       DateTime  @default(now())
  
  @@index([listingId])
  @@index([createdAt])
}

// ============================================================================
// MESSAGING SYSTEM
// ============================================================================

model MessageThread {
  id              String    @id @default(cuid())
  
  // Participants
  participantIds  String[]  // Array of user IDs
  participants    User[]
  
  // Related listing
  listingId       String?
  
  // Thread info
  subject         String?
  previewMessage  String?   @db.Text
  lastUpdated     DateTime  @updatedAt
  
  // Messages in this thread
  messages        Message[]
  
  createdAt       DateTime  @default(now())
  
  @@index([participantIds])
  @@index([lastUpdated])
  @@index([createdAt])
}

model Message {
  id              String    @id @default(cuid())
  
  threadId        String
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  senderId        String
  sender          User      @relation("sender", fields: [senderId], references: [id], onDelete: Cascade)
  
  recipientId     String
  recipient       User      @relation("recipient", fields: [recipientId], references: [id], onDelete: Cascade)
  
  content         String    @db.Text
  readStatus      Boolean   @default(false)
  readAt          DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([threadId])
  @@index([senderId])
  @@index([recipientId])
  @@index([readStatus])
  @@index([createdAt])
}

// ============================================================================
// WISHLIST & FAVORITES
// ============================================================================

model Wishlist {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  
  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@index([createdAt])
}

// ============================================================================
// RECENTLY VIEWED
// ============================================================================

model RecentlyViewed {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String
  listing         HostListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  viewedAt        DateTime  @default(now())
  
  @@index([userId])
  @@index([viewedAt])
}

// ============================================================================
// DOCUMENTS (Insurance, Permits, Titles, Waivers)
// ============================================================================

model Document {
  id              String    @id @default(cuid())
  
  // Document metadata
  type            DocumentType
  category        String  // e.g., "liability_insurance", "business_license"
  status          DocumentStatus @default(PENDING)
  
  // Relationships
  userId          String?
  user            User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId       String?
  listing         HostListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  bookingId       String?
  booking         Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  // File storage
  fileUrl         String
  fileKey         String  @unique
  mimeType        String
  fileSize        Int
  
  // Verification
  uploadedBy      String
  verifiedBy      String?
  verifiedAt      DateTime?
  expiresAt       DateTime?
  
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([listingId])
  @@index([bookingId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum DocumentType {
  INSURANCE
  PERMIT
  TITLE
  WAIVER
  AGREEMENT
  LICENSE
  INSPECTION
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

// ============================================================================
// SUBSCRIPTIONS (Renter Pro, Host Plans)
// ============================================================================

model Subscription {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planType        SubscriptionType
  status          SubscriptionStatus @default(ACTIVE)
  
  // Pricing
  pricePerMonth   Float
  billingCycle    Int  // Days
  
  // Duration
  startDate       DateTime
  endDate         DateTime?
  autoRenew       Boolean @default(true)
  
  // Discounts
  discountPercent Float @default(0)
  couponCode      String?
  
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([planType])
  @@index([status])
  @@index([createdAt])
}

enum SubscriptionType {
  RENTER_PRO
  HOST_STANDARD
  HOST_PREMIUM
  ADMIN_PLATFORM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAUSED
  EXPIRED
}

// ============================================================================
// TRANSACTIONS & PAYMENTS
// ============================================================================

model Transaction {
  id              String    @id @default(cuid())
  
  // Transaction metadata
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  // Parties
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Related entity
  bookingId       String?
  booking         Booking? @relation(fields: [bookingId], references: [id])
  
  listingId       String?
  listing         HostListing? @relation(fields: [listingId], references: [id])
  
  // Amount
  amount          Float
  currency        String @default("USD")
  platformFee     Float @default(0)
  commission      Float @default(0)
  netAmount       Float
  
  // Payment method
  paymentMethod   String?
  paymentIntentId String?
  
  // Refund tracking
  refundAmount    Float @default(0)
  refundReason    String?
  
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  processedAt     DateTime?
  
  @@index([userId])
  @@index([bookingId])
  @@index([listingId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum TransactionType {
  BOOKING_PAYMENT
  REFUND
  PAYOUT
  COMMISSION
  PLATFORM_FEE
  SUBSCRIPTION_CHARGE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}
